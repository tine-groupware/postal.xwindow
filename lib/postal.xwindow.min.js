/*!
 *  * postal.xwindow - postal.js/postal.federation plugin for federating instances of postal.js across unrelated window boundaries.
 *  * Author: Cornelius Wei√ü (http://www.metaways.de)
 *  * Version: v0.0.6
 *  * Url: http://github.com/tine20/postal.xwindow
 *  * License(s): (MIT OR GPL-2.0)
 */
(function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("lodash"),require("postal")):"function"==typeof define&&define.amd?define(["lodash","postal"],t):"object"==typeof exports?exports.postalXWindow=t(require("lodash"),require("postal")):e.postalXWindow=t(e._,e.postal)})(this,function(e,t){return function(e){function t(n){if(r[n])return r[n].exports;var i=r[n]={exports:{},id:n,loaded:!1};return e[n].call(i.exports,i,i.exports,t),i.loaded=!0,i.exports}var r={};return t.m=e,t.c=r,t.p="",t(0)}([function(e,t,r){var n=r(1),i=r(2),o=r(3),s=r(4),a=s.state,c=s.env,u=r(5);u.getInstance=function(e,t,r){return new u(e,t,r)},i.fedx.transports.xwindow={eagerSerialize:c.useEagerSerialize,remotes:[],XWindowClient:u,configure:function(e){return e&&(a.config=n.defaults(n.extend(a.config,e),a.defaults)),a.config},clearConfiguration:function(){a.config=n.extend({},a.defaults)},disconnect:function(e){e=e||{};var t=e.instanceId?n.reduce(n.isArray(e.instanceId)?e.instanceId:[e.instanceId],n.bind(o._memoRemoteByInstanceId,this),[]):e.target?n.reduce(n.isArray(e.target)?e.target:[e.target],n.bind(o._memoRemoteByTarget,this),[]):this.remotes;e.doNotNotify||n.forEach(t,n.bind(o._disconnectClient,this)),this.remotes=n.without.apply(null,[this.remotes].concat(t))},getTargets:function(){return this.tidyStorage()},sendMessage:function(e){var t=e;a.config.safeSerialize&&(t=o.safeSerialize(n.cloneDeep(e)));var r=i.instanceId();n.forEach(this.remotes,function(e){e.instanceId!=r&&e.sendMessage(t)})},wrapForTransport:c.useEagerSerialize?function(e){return JSON.stringify({postal:!0,packingSlip:e})}:function(e){return{postal:!0,packingSlip:e}},unwrapFromTransport:function(e){if("string"!=typeof e||!c.useEagerSerialize&&e.indexOf('"postal":true')===-1)return e;try{return JSON.parse(e)}catch(t){return{}}},routeMessage:function(e){var t=this.unwrapFromTransport(e.newValue);if(t&&t.postal){var r=t.packingSlip,s=r.instanceId;if(r&&s!=i.instanceId()){var c=n.find(this.remotes,function(e){return e.instanceId===s});if(!c){var f=store.namespace(a.config.localStoragePrefix+"."+s);c=u.getInstance(f,{origin:f.get("targetUrl")},s),this.remotes.push(c)}var g=o.parseUri(e.url),d=g.protocol+"://"+g.authority;c.options.origin==d&&c.onMessage(r)}}},signalReady:function(e,t){var r=i.instanceId(),o=this;this.target=store.namespace(a.config.localStoragePrefix+"."+r),this.target.on("message",n.bind(this.routeMessage,this)),this.keepAlive(),e=n.isArray(e)?e:[e],e=e.length?e:this.getTargets(),t=t||function(){},n.forEach(e,n.bind(function(e){if(e.targetId!=r){var i=n.find(o.remotes,function(t){return t.instanceId===e.targetId});i||(i=u.getInstance(e.target,{origin:e.origin},e.targetId),o.remotes.push(i)),i.sendPing(t)}},this))},keepAlive:function(){this.target.set("targetUrl",c.origin),this.target.set("targetTimeout",(new Date).getTime()+a.config.targetTimeout),this.tidyStorage(),this.tidyRemotes(),n.delay(n.bind(this.keepAlive,this),Math.round(a.config.targetTimeout/2))},tidyStorage:function(){var e=n.reduce(store.namespace(a.config.localStoragePrefix).getAll(),function(e,t,r){var i=r.split(".")[0];return n.indexOf(e,i)<0&&e.push(i),e},[]),t=(new Date).getTime();return n.reduce(e,function(e,r){var n=store.namespace(a.config.localStoragePrefix+"."+r);return n.get("targetTimeout")<t?n.clear():e.push({targetId:r,target:n,origin:n.get("targetUrl")}),e},[])},tidyRemotes:function(){var e=this;n.forEach(this.remotes,function(t){n.isEmpty(t.target.getAll())&&e.disconnect({target:t.target})})}}},function(t,r){t.exports=e},function(e,r){e.exports=t},function(e,t,r){var n=r(1),i=function(e,t){var r=n.find(this.remotes,function(e){return e.instanceId===t});return r&&e.push(r),e},o=function(e,t){var r=n.find(this.remotes,function(e){return e.target===t});return r&&e.push(r),e},s=function(e){e.disconnect()};safeSerialize=function(e){var t=JSON.parse(JSON.stringify(e,function(e,t){if("function"!=typeof t)return t}));return t};
// (c) Steven Levithan <stevenlevithan.com>
// MIT License
var a=function(e){for(var t=a.options,r=t.parser[t.strictMode?"strict":"loose"].exec(e),n={},i=14;i--;)n[t.key[i]]=r[i]||"";return n[t.q.name]={},n[t.key[12]].replace(t.q.parser,function(e,r,i){r&&(n[t.q.name][r]=i)}),n};a.options={strictMode:!1,key:["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"],q:{name:"queryKey",parser:/(?:^|&)([^&=]*)=?([^&]*)/g},parser:{strict:/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,loose:/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/}},e.exports={_memoRemoteByInstanceId:i,_memoRemoteByTarget:o,_disconnectClient:s,safeSerialize:safeSerialize,parseUri:a}},function(e,t,r){var n=r(1),i={origin:location.origin||location.protocol+"//"+location.host,isWorker:"undefined"==typeof window&&postMessage&&location,useEagerSerialize:/MSIE [8,9]/.test(navigator.userAgent)},o={allowedOrigins:[i.origin],enabled:!0,safeSerialize:!1,localStoragePrefix:"postal.fedx.xwindow",targetTimeout:6e4},s={workers:[],config:n.extend({},o),defaults:o};e.exports={state:s,env:i}},function(e,t,r){var n=r(1),i=r(2),o=r(4),s=o.state,a=o.env,c=function(){i.fedx.FederationClient.apply(this,arguments)};c.prototype=n.create(i.fedx.FederationClient.prototype,{constructor:c,transportName:"xwindow",shouldProcess:function(){var e=!!s.config.allowedOrigins.length;return s.config.enabled&&("*"===this.options.origin||e&&n.includes(s.config.allowedOrigins,this.options.origin)||!e||this.options.isWorker&&n.includes(s.workers,this.target)||a.isWorker)},send:function(e){if(this.shouldProcess()){var t=i.fedx.transports.xwindow.wrapForTransport(e);this.target.set("message",t)}}}),e.exports=c}])});
//# sourceMappingURL=postal.xwindow.min.js.map
