/*!
 *  * postal.xwindow - postal.js/postal.federation plugin for federating instances of postal.js across unrelated window boundaries.
 *  * Author: Cornelius WeiÃŸ (http://www.metaways.de)
 *  * Version: v0.0.2
 *  * Url: http://github.com/tine20/postal.xwindow
 *  * License(s): (MIT OR GPL-2.0)
 */
(function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("lodash"),require("postal")):"function"==typeof define&&define.amd?define(["lodash","postal"],t):"object"==typeof exports?exports.postalXWindow=t(require("lodash"),require("postal")):e.postalXWindow=t(e._,e.postal)})(this,function(e,t){return function(e){function t(n){if(r[n])return r[n].exports;var o=r[n]={exports:{},id:n,loaded:!1};return e[n].call(o.exports,o,o.exports,t),o.loaded=!0,o.exports}var r={};return t.m=e,t.c=r,t.p="",t(0)}([function(e,t,r){var n=function(e){return e&&e.__esModule?e["default"]:e},o=n(r(1)),i=n(r(2)),a=r(3),s=a._memoRemoteByInstanceId,c=a._memoRemoteByTarget,u=a._disconnectClient,f=a.safeSerialize,l=a.parseUri,p=r(4),g=p.state,d=p.env,h=n(r(5));h.getInstance=function(e,t,r){return new h(e,t,r)},i.fedx.transports.xwindow={eagerSerialize:d.useEagerSerialize,remotes:[],XWindowClient:h,configure:function(e){return e&&(g.config=o.defaults(o.extend(g.config,e),g.defaults)),g.config},clearConfiguration:function(){g.config=o.extend({},g.defaults)},disconnect:function(e){e=e||{};var t=e.instanceId?o.reduce(o.isArray(e.instanceId)?e.instanceId:[e.instanceId],s,[],this):e.target?o.reduce(o.isArray(e.target)?e.target:[e.target],c,[],this):this.remotes;e.doNotNotify||o.each(t,u,this),this.remotes=o.without.apply(null,[this.remotes].concat(t))},getTargets:function(){return this.tidyStorage(),o.reduce(store.namespace(g.config.localStoragePrefix).getAll(),function(e,t,r){if(r.match(/\.targetTimeout$/)){var n=r.split(".")[0],o=store.namespace(g.config.localStoragePrefix+"."+n);e.push({targetId:n,target:o,origin:o.get("targetUrl")})}return e},[])},sendMessage:function(e){var t=e;g.config.safeSerialize&&(t=f(o.cloneDeep(e)));var r=i.instanceId();o.each(this.remotes,function(e){e.instanceId!=r&&e.sendMessage(t)})},wrapForTransport:d.useEagerSerialize?function(e){return JSON.stringify({postal:!0,packingSlip:e})}:function(e){return{postal:!0,packingSlip:e}},unwrapFromTransport:function(e){if("string"!=typeof e||!d.useEagerSerialize&&-1===e.indexOf('"postal":true'))return e;try{return JSON.parse(e)}catch(t){return{}}},routeMessage:function(e){var t=this,r=this.unwrapFromTransport(e.newValue);if(r&&r.postal){var n,a;(function(){var s=r.packingSlip,c=s.instanceId;if(s&&c!=i.instanceId()){n=o.find(t.remotes,function(e){return e.instanceId===c}),n||(a=store.namespace(g.config.localStoragePrefix+"."+c),n=h.getInstance(a,{origin:a.get("targetUrl")},c),t.remotes.push(n));var u=l(e.url),f=u.protocol+"://"+u.authority;n.options.origin==f&&n.onMessage(s)}})()}},signalReady:function(e,t){var r=i.instanceId(),n=this;this.target=store.namespace(g.config.localStoragePrefix+"."+r),this.target.set("targetUrl",d.origin),this.target.on("message",o.bind(this.routeMessage,this)),this.keepAlive(),e=o.isArray(e)?e:[e],e=e.length?e:this.getTargets(),t=t||function(){},o.each(e,function(e){if(e.targetId!=r){var i=o.find(n.remotes,function(t){return t.instanceId===e.targetId});i||(i=h.getInstance(e.target,{origin:e.origin},e.targetId),n.remotes.push(i)),i.sendPing(t)}},this)},keepAlive:function(){this.target.set("targetTimeout",(new Date).getTime()+g.config.targetTimeout),this.tidyStorage(),this.tidyRemotes(),o.delay(o.bind(this.keepAlive,this),Math.round(g.config.targetTimeout/2))},tidyStorage:function(){var e=(new Date).getTime();o.each(store.namespace(g.config.localStoragePrefix).getAll(),function(t,r){if(r.match(/\.targetTimeout$/)&&e>t){var n=r.split(".")[0];store.namespace(g.config.localStoragePrefix+"."+n).clear()}})},tidyRemotes:function(){var e=this;o.each(this.remotes,function(t){o.isEmpty(t.target.getAll())&&e.disconnect({target:t.target})})}}},function(t,r){t.exports=e},function(e,r){e.exports=t},function(e,t,r){function n(e,t){var r=f.find(this.remotes,function(e){return e.instanceId===t});return r&&e.push(r),e}function o(e,t){var r=f.find(this.remotes,function(e){return e.target===t});return r&&e.push(r),e}function i(e){e.disconnect()}function a(e){var t=!0,r=!1,n=void 0;try{for(var o,i=l(e)[Symbol.iterator]();!(t=(o=i.next()).done);t=!0){var s=u(o.value,2),c=s[0],p=s[1];"function"==typeof p&&delete e[c],f.isPlainObject(p)&&a(p),f.isArray(p)&&f.each(p,a)}}catch(g){r=!0,n=g}finally{try{!t&&i["return"]&&i["return"]()}finally{if(r)throw n}}return e}function s(e){for(var t=s.options,r=t.parser[t.strictMode?"strict":"loose"].exec(e),n={},o=14;o--;)n[t.key[o]]=r[o]||"";return n[t.q.name]={},n[t.key[12]].replace(t.q.parser,function(e,r,o){r&&(n[t.q.name][r]=o)}),n}var c=function(e){return e&&e.__esModule?e["default"]:e},u=function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e)){for(var r,n=[],o=e[Symbol.iterator]();!(r=o.next()).done&&(n.push(r.value),!t||n.length!==t););return n}throw new TypeError("Invalid attempt to destructure non-iterable instance")};t._memoRemoteByInstanceId=n,t._memoRemoteByTarget=o,t._disconnectClient=i,t.safeSerialize=a,
// (c) Steven Levithan <stevenlevithan.com>
// MIT License
t.parseUri=s,Object.defineProperty(t,"__esModule",{value:!0});var f=c(r(1)),l=regeneratorRuntime.mark(function p(e){var t,r,n,o,i,a;return regeneratorRuntime.wrap(function(s){for(;;)switch(s.prev=s.next){case 0:-1===["object","function"].indexOf(typeof e)&&(e={}),t=!0,r=!1,n=void 0,s.prev=4,o=Object.keys(e)[Symbol.iterator]();case 6:if(t=(i=o.next()).done){s.next=13;break}return a=i.value,s.next=10,[a,e[a]];case 10:t=!0,s.next=6;break;case 13:s.next=19;break;case 15:s.prev=15,s.t0=s["catch"](4),r=!0,n=s.t0;case 19:s.prev=19,s.prev=20,!t&&o["return"]&&o["return"]();case 22:if(s.prev=22,!r){s.next=25;break}throw n;case 25:return s.finish(22);case 26:return s.finish(19);case 27:case"end":return s.stop()}},p,this,[[4,15,19,27],[20,,22,26]])});t.entries=l,s.options={strictMode:!1,key:["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"],q:{name:"queryKey",parser:/(?:^|&)([^&=]*)=?([^&]*)/g},parser:{strict:/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,loose:/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/}}},function(e,t,r){var n=function(e){return e&&e.__esModule?e["default"]:e};Object.defineProperty(t,"__esModule",{value:!0});var o=n(r(1)),i={origin:location.origin||location.protocol+"//"+location.host,isWorker:"undefined"==typeof window&&postMessage&&location,useEagerSerialize:/MSIE [8,9]/.test(navigator.userAgent)};t.env=i;var a={allowedOrigins:[i.origin],enabled:!0,safeSerialize:!1,localStoragePrefix:"postal.fedx.xwindow",targetTimeout:6e4},s={workers:[],config:o.extend({},a),defaults:a};t.state=s},function(e,t,r){var n=function(e){return e&&e.__esModule?e["default"]:e},o=function(){function e(e,t){for(var r in t){var n=t[r];n.configurable=!0,n.value&&(n.writable=!0)}Object.defineProperties(e,t)}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=function d(e,t,r){var n=Object.getOwnPropertyDescriptor(e,t);if(void 0===n){var o=Object.getPrototypeOf(e);return null===o?void 0:d(o,t,r)}if("value"in n&&n.writable)return n.value;var i=n.get;if(void 0!==i)return i.call(r)},a=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(e.__proto__=t)},s=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},c=n(r(2)),u=n(r(1)),f=r(4),l=f.state,p=f.env,g=function(e){function t(){for(var e=arguments.length,r=Array(e),n=0;e>n;n++)r[n]=arguments[n];s(this,t),this.transportName="xwindow",i(Object.getPrototypeOf(t.prototype),"constructor",this).apply(this,r)}return a(t,e),o(t,{shouldProcess:{value:function(){var e=!!l.config.allowedOrigins.length;return l.config.enabled&&("*"===this.options.origin||e&&u.contains(l.config.allowedOrigins,this.options.origin)||!e||this.options.isWorker&&u.contains(l.workers,this.target)||p.isWorker)}},send:{value:function(e){if(this.shouldProcess()){var t=c.fedx.transports.xwindow.wrapForTransport(e);this.target.set("message",t)}}}}),t}(c.fedx.FederationClient);e.exports=g}])});
//# sourceMappingURL=postal.xwindow.min.js.map
