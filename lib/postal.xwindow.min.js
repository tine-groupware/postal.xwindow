/*!
 *  * postal.xwindow - postal.js/postal.federation plugin for federating instances of postal.js across unrelated window boundaries.
 *  * Author: Cornelius Wei√ü (http://www.metaways.de)
 *  * Version: v0.0.3
 *  * Url: http://github.com/tine20/postal.xwindow
 *  * License(s): (MIT OR GPL-2.0)
 */
(function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("lodash"),require("postal")):"function"==typeof define&&define.amd?define(["lodash","postal"],t):"object"==typeof exports?exports.postalXWindow=t(require("lodash"),require("postal")):e.postalXWindow=t(e._,e.postal)})(this,function(e,t){return function(e){function t(n){if(r[n])return r[n].exports;var i=r[n]={exports:{},id:n,loaded:!1};return e[n].call(i.exports,i,i.exports,t),i.loaded=!0,i.exports}var r={};return t.m=e,t.c=r,t.p="",t(0)}([function(e,t,r){r(1);var n=r(2),i=r(3),o=r(4),a=o.state,s=o.env,c=r(5);c.getInstance=function(e,t,r){return new c(e,t,r)},n.fedx.transports.xwindow={eagerSerialize:s.useEagerSerialize,remotes:[],XWindowClient:c,configure:function(e){return e&&(a.config=_.defaults(_.extend(a.config,e),a.defaults)),a.config},clearConfiguration:function(){a.config=_.extend({},a.defaults)},disconnect:function(e){e=e||{};var t=e.instanceId?_.reduce(_.isArray(e.instanceId)?e.instanceId:[e.instanceId],i._memoRemoteByInstanceId,[],this):e.target?_.reduce(_.isArray(e.target)?e.target:[e.target],i._memoRemoteByTarget,[],this):this.remotes;e.doNotNotify||_.each(t,i._disconnectClient,this),this.remotes=_.without.apply(null,[this.remotes].concat(t))},getTargets:function(){return this.tidyStorage()},sendMessage:function(e){var t=e;a.config.safeSerialize&&(t=i.safeSerialize(_.cloneDeep(e)));var r=n.instanceId();_.each(this.remotes,function(e){e.instanceId!=r&&e.sendMessage(t)})},wrapForTransport:s.useEagerSerialize?function(e){return JSON.stringify({postal:!0,packingSlip:e})}:function(e){return{postal:!0,packingSlip:e}},unwrapFromTransport:function(e){if("string"!=typeof e||!s.useEagerSerialize&&-1===e.indexOf('"postal":true'))return e;try{return JSON.parse(e)}catch(t){return{}}},routeMessage:function(e){var t=this.unwrapFromTransport(e.newValue);if(t&&t.postal){var r=t.packingSlip,o=r.instanceId;if(r&&o!=n.instanceId()){var s=_.find(this.remotes,function(e){return e.instanceId===o});if(!s){var u=store.namespace(a.config.localStoragePrefix+"."+o);s=c.getInstance(u,{origin:u.get("targetUrl")},o),this.remotes.push(s)}var f=i.parseUri(e.url),g=f.protocol+"://"+f.authority;s.options.origin==g&&s.onMessage(r)}}},signalReady:function(e,t){var r=n.instanceId(),i=this;this.target=store.namespace(a.config.localStoragePrefix+"."+r),this.target.on("message",_.bind(this.routeMessage,this)),this.keepAlive(),e=_.isArray(e)?e:[e],e=e.length?e:this.getTargets(),t=t||function(){},_.each(e,function(e){if(e.targetId!=r){var n=_.find(i.remotes,function(t){return t.instanceId===e.targetId});n||(n=c.getInstance(e.target,{origin:e.origin},e.targetId),i.remotes.push(n)),n.sendPing(t)}},this)},keepAlive:function(){this.target.set("targetUrl",s.origin),this.target.set("targetTimeout",(new Date).getTime()+a.config.targetTimeout),this.tidyStorage(),this.tidyRemotes(),_.delay(_.bind(this.keepAlive,this),Math.round(a.config.targetTimeout/2))},tidyStorage:function(){var e=_.reduce(store.namespace(a.config.localStoragePrefix).getAll(),function(e,t,r){var n=r.split(".")[0];return _.indexOf(e,n)<0&&e.push(n),e},[]),t=(new Date).getTime();return _.reduce(e,function(e,r){var n=store.namespace(a.config.localStoragePrefix+"."+r);return n.get("targetTimeout")<t?n.clear():e.push({targetId:r,target:n,origin:n.get("targetUrl")}),e},[])},tidyRemotes:function(){var e=this;_.each(this.remotes,function(t){_.isEmpty(t.target.getAll())&&e.disconnect({target:t.target})})}}},function(t,r){t.exports=e},function(e,r){e.exports=t},function(e,t,r){r(1);var n=function(e,t){var r=_.find(this.remotes,function(e){return e.instanceId===t});return r&&e.push(r),e},i=function(e,t){var r=_.find(this.remotes,function(e){return e.target===t});return r&&e.push(r),e},o=function(e){e.disconnect()};safeSerialize=function(e){var t=JSON.parse(JSON.stringify(e,function(e,t){return"function"!=typeof t?t:void 0}));return t};
// (c) Steven Levithan <stevenlevithan.com>
// MIT License
var a=function(e){for(var t=a.options,r=t.parser[t.strictMode?"strict":"loose"].exec(e),n={},i=14;i--;)n[t.key[i]]=r[i]||"";return n[t.q.name]={},n[t.key[12]].replace(t.q.parser,function(e,r,i){r&&(n[t.q.name][r]=i)}),n};a.options={strictMode:!1,key:["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"],q:{name:"queryKey",parser:/(?:^|&)([^&=]*)=?([^&]*)/g},parser:{strict:/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,loose:/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/}},e.exports={_memoRemoteByInstanceId:n,_memoRemoteByTarget:i,_disconnectClient:o,safeSerialize:safeSerialize,parseUri:a}},function(e,t,r){r(1);var n={origin:location.origin||location.protocol+"//"+location.host,isWorker:"undefined"==typeof window&&postMessage&&location,useEagerSerialize:/MSIE [8,9]/.test(navigator.userAgent)},i={allowedOrigins:[n.origin],enabled:!0,safeSerialize:!1,localStoragePrefix:"postal.fedx.xwindow",targetTimeout:6e4},o={workers:[],config:_.extend({},i),defaults:i};e.exports={state:o,env:n}},function(e,t,r){r(1);var n=r(2),i=r(4),o=i.state,a=i.env,s=function(){n.fedx.FederationClient.apply(this,arguments)};s.prototype=_.create(n.fedx.FederationClient.prototype,{constructor:s,transportName:"xwindow",shouldProcess:function(){var e=!!o.config.allowedOrigins.length;return o.config.enabled&&("*"===this.options.origin||e&&_.contains(o.config.allowedOrigins,this.options.origin)||!e||this.options.isWorker&&_.contains(o.workers,this.target)||a.isWorker)},send:function(e){if(this.shouldProcess()){var t=n.fedx.transports.xwindow.wrapForTransport(e);this.target.set("message",t)}}}),e.exports=s}])});
//# sourceMappingURL=postal.xwindow.min.js.map
